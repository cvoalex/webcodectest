<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPLE Working Pipeline - 22.6 FPS</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .title {
            text-align: center;
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .pipeline-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .pipeline-section h2 {
            margin-top: 0;
            color: #4CAF50;
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #ff7043, #ff5722);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .status-success { color: #4CAF50; }
        .status-pending { color: #FFC107; }
        .status-error { color: #f44336; }

        #canvas {
            border: 2px solid #4CAF50;
            border-radius: 8px;
            background: #000;
        }

        #log {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üöÄ SIMPLE Working Pipeline</h1>
        <p class="subtitle">22.6 FPS Performance - No Batch Processing</p>

        <!-- Control Panel -->
        <div class="pipeline-section">
            <h2>üéÆ Control Panel</h2>
            <div class="input-group">
                <label for="test-text">Text to Speech:</label>
                <textarea id="test-text" rows="3" placeholder="Hello, this is a simple test!">Hello, this is a simple test of the working pipeline!</textarea>
            </div>
            <div class="input-group">
                <label for="model-select">Select Model:</label>
                <select id="model-select">
                    <option value="default_model">default_model (Default)</option>
                </select>
            </div>
            
            <button class="btn" onclick="startSimplePipeline()">üöÄ Start SIMPLE Pipeline</button>
            <button class="btn secondary" onclick="clearTest()">üóëÔ∏è Clear & Reset</button>
        </div>

        <!-- Display -->
        <div class="pipeline-section">
            <h2>üé¨ Live Video Output</h2>
            <canvas id="canvas" width="512" height="512"></canvas>
            <div style="margin-top: 10px;">
                <strong>Frame: <span id="frame-counter">0</span> | FPS: <span id="fps-counter">0.0</span></strong>
            </div>
        </div>

        <!-- Log -->
        <div class="pipeline-section">
            <h2>üìù System Log</h2>
            <div id="log"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="realtime_lipsync_client.js"></script>
    <script src="audio_buffer_manager.js"></script>
    <script src="direct_websocket_client_simple.js"></script>
    
    <script>
        // Global variables
        let client = null;
        let frameGenerator = null;
        let messagesSent = 0;

        // UI functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#FFC107';
            
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Start the simple pipeline
        async function startSimplePipeline() {
            try {
                log('üöÄ Starting SIMPLE Working Pipeline...', 'info');
                
                const testText = document.getElementById('test-text').value;
                const modelName = document.getElementById('model-select').value;
                
                // Step 1: Initialize OpenAI client
                log('ü§ñ Initializing OpenAI Realtime API...', 'info');
                client = new RealtimeLipSyncClient();
                
                // Step 2: Initialize SIMPLE WebSocket Client
                log('üöÄ Initializing SIMPLE WebSocket Client - 22.6 FPS mode!', 'info');
                frameGenerator = new DirectWebSocketClient('ws://localhost:8082', modelName);
                
                // Connect frame display
                frameGenerator.onFrameReady = function(frameData) {
                    log(`üé¨ SIMPLE Frame ready: ${frameData.frameId} (${frameData.processingTime.toFixed(1)}ms)`, 'success');
                    displayFrame(frameData);
                };
                
                // Step 3: Connect WebSocket
                await frameGenerator.connect();
                log('‚úÖ SIMPLE WebSocket connected!', 'success');
                
                // Step 4: Start OpenAI session and audio pipeline
                log('üéµ Starting audio pipeline...', 'info');
                await client.startSession(testText);
                
                // Connect audio to frame generation
                frameGenerator.startGeneratingFromBuffer(client.audioBufferManager);
                
                log('‚úÖ SIMPLE Pipeline started successfully!', 'success');
                log('üöÄ Expecting 22.6 FPS performance!', 'success');
                
            } catch (error) {
                log(`‚ùå Pipeline startup failed: ${error.message}`, 'error');
                console.error('Pipeline error:', error);
            }
        }

        // Display frame on canvas
        function displayFrame(frameData) {
            try {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                
                // Update counters
                document.getElementById('frame-counter').textContent = frameData.frameId;
                if (frameGenerator && frameGenerator.stats) {
                    document.getElementById('fps-counter').textContent = frameGenerator.stats.frameRate.toFixed(1);
                }
                
                // Create and display image
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = `data:image/jpeg;base64,${frameData.imageData}`;
                
            } catch (error) {
                console.error('Error displaying frame:', error);
            }
        }

        function clearTest() {
            if (client) {
                client.endSession();
                client = null;
            }
            
            if (frameGenerator) {
                frameGenerator.reset();
                frameGenerator = null;
            }
            
            messagesSent = 0;
            document.getElementById('frame-counter').textContent = '0';
            document.getElementById('fps-counter').textContent = '0.0';
            document.getElementById('log').innerHTML = '';
            
            // Clear canvas
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            log('üóëÔ∏è Test cleared and reset', 'info');
        }
    </script>
</body>
</html>
